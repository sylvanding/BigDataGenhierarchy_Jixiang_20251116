# 1.1 总体架构

本项目各个包的功能介绍如下：

| 包名       | 功能介绍                                                     |
| ---------- | ------------------------------------------------------------ |
| app        | 前端接口。快速构建的入口，封装了一些用户常用的情景的快速实现。 |
| metric     | 距离函数。一些常见的距离函数。                               |
| type       | 数据类型。一些常见的数据类型，已经管理这些数据类型的表。     |
| index      | 索引构建。一些索引构建用到的类，包括索引树的抽象、索引表的构造搜索类等。 |
| algorithms | 常用算法。包含了一些算法，例如支撑点选择、数据划分、聚类、分类等算法的具体实现。 |
| util       | 工具包。包含映射类、数据加载类等。                           |
| mckoi      | 最底层的数据库。                                             |

项目的交互过程如下：

![项目交互图][1]



## 1.1.1 索引构建
`UMAD` 的索引构建部分主要由`Metric`、 `PivotSelectionMethod` 、`PartitionMethod`和`Index`组成。分别对应度量空间相似性搜索领域的距离函数、支撑点选择、数据划分和索引，他们最终由`Table`组织存储起来，并由`Table.buildVPIndex()`调用之后生成索引数据库文件存储在内存之中。

```java
         /*
         * 创建数据库，要根据之前指定的数据类型创建指定类型的数据库,具体对应如下：
         * ms        SpectraTable
         * msms      SpectraWithPrecursorMassTable
         * dna       DNATable
         * rna       RNATable
         * protein   PeptideTable
         * vector    DoubleVectorTable
         * image     ImageTable
         */
        Table table = null;
        try {
            table = new DoubleVectorTable(fileName,indexPrefix,initialSize,2, new CountedMetric( LMetric.EuclideanDistanceMetric));

            startTime = System.currentTimeMillis();

            /*利用这个刚刚创建和列表进行建树*/
            table.buildVPIndex(psm, pNum, dpm, sf, maxLeafSize, pathLength, bucket, mode,forPrint);

            endTime = System.currentTimeMillis();
            if (Debug.LEVEL != Level.OFF) {
                System.out.println(" building size:" + table.size());
                System.out.println("构建时间："+((endTime-startTime)/1000.00)+"\n"
                        +"距离计算次数："+((CountedMetric)table.getMetric()).getCounter());
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
```

## 1.1.2 相似性搜索

UMAD的搜索部分主要是由```Query```和```Cursor```构成。其中前者是搜索操作的实体类，后者是搜索结果集中的迭代器。要执行搜索操作大致分为以下几个步骤

``加载搜索目标点入Table ==》构建范围搜索对象Query ==》执行index.search()拿到结果集的迭代器Cursor ==》遍历迭代器 ``

```java
        Index index = TableManager.getTableManager("vpindex").getTable("vpindex").getIndex();
        Table queryTable = null;
        try {
            queryTable = new DoubleVectorTable("D:\\WorkSpace\\IDEA\\UMAD\\testdata\\query\\2.txt", "", 2, 2);
        } catch (IOException e) {
            e.printStackTrace();
        }
        List allQuery = queryTable.getData();
        RangeQuery q = new RangeQuery((IndexObject) allQuery.get(0), 0.1);
        VPRangeCursor cursor = (VPRangeCursor) index.search(q);
        while (cursor.hasNext()) {
            System.out.println(cursor.next().getObject());
        }
```

******
[1]:https://gitee.com/LittleBoyer/pic/raw/master/img/项目交互图.png